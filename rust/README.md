# 🦀 RedStone SmartWeave contracts - Rust template

Following repository is a template for writing SmartWeave contracts in Rust and building them into WASM binaries which can be then processed by RedStone SmartWeave SDK.

It contains an example implementation of a PST contract - which you can use as a base for implementing your own contract.
If you are not familiar with the concept of Profit Sharing Tokens, check out a [tutorial](https://redstone.academy/docs/pst/introduction/intro) for writing your first PST contract in our RedStone Academy.

- [Code structure](#code-structure)
- [Installation](#installation)
- [Writing contract](#writing-contract)
- [Build](#build)
- [Tests](#tests)
- [Deploy](#deploy)
- [Using SDK](#using-sdk)

## 🔍 Code structure
- [deploy/](deploy) - contains deployment scripts for localhost/testnet/mainnet and contract's initial state definition
- [pkg/](pkg) - generated by `wasm-pack` during build process - contains compiled wasm binary, js "glue" code, etc.
- [src/](src) - contains the source code of the contract
  - [actions/](src/actions) - the main part of the contract - contains `actions` (functions) that can be called to interact
    with the contract (and either change its internal state or return a view of the current state).
    These functions contain all the business logic of the contract
  - [contract_utils/](src/contract_utils) - contains low-level code responsible for mapping types, storing state,
  definition of functions imported from js, etc.   
  🔥Do Not Edit🔥, unless you really know what you're doing :-)
  - [action.rs](src/action.rs) - contains an enum with all contract's actions and the definition of response
    messages (for "view" actions - like PST's `balance` action)
  - [contract.rs](src/contract.rs) - entry point (from the contract's developer perspective) to the contract.
    Contains the `handle` function that calls specific contract's functions based on passed action
  - [error.rs](src/error.rs) - contains the definition of contract's business errors (e.g. "not enough balance")
  - [state.rs](src/state.rs) - contains the definition of contract's state
- [tests/](tests) - contains integration tests written in Jest


## 📦 Installation

You will need:
- Rust :-) (https://doc.rust-lang.org/cargo/getting-started/installation.html) 
- [wasm-pack](https://rustwasm.github.io/wasm-pack/installer/) (on Apple's M1s use `cargo install wasm-pack`)
- [Node.js](https://nodejs.org/en/download/) version 16.5 or above
- [yarn](https://yarnpkg.com/getting-started/install) installed

To install all Node.js dependencies run the following command:
```bash
yarn install
```

## 🧑‍💻 Writing contract

If you want to edit contract's code and create your own implementation you can do it by following these steps:

1. Edit `init-state.json` by adding the initial state for your contract - [deploy/state/init-state.json](deploy/state/init-state.json)
2. Modify the state definition of the contract - [src/state.rs](src/state.rs)
3. Edit/add actions which user will be able to call while interacting with the contract - [src/actions](src/actions).
We suggest keeping each action in a separate file.
4. Add schemas which should describe input and output types for your actions - [src/action.rs](src/action.rs)
5. Add above action functions to the pattern matching `handle` function in [src/contract.rs](src/contract.rs#L9)

### 👷 Build
Compile your contract to WASM binary by running following command:

```bash
yarn run build
```

### 🧪 Tests
Write tests for your contract (we will use Jest library for testing) - you can find a template in the [tests/](tests) folder.
Run tests with
```bash
yarn run test
```

### 📜 Deploy
Deploy your contract to one of the networks (mainnet/RedStone public testnet/localhost) by running following command (`network`: `mainnet` | `testnet` | `local`)

```bash
yarn run deploy:[network]
```

💡**NOTE**: If you want to deploy your contract locally you need to run Arlocal by typing following command:

```bash
npx arlocal
```

💡**NOTE**: When using mainnet please put your wallet key in [deploy/mainnet/.secrets/wallet-mainnet.json](deploy/mainnet/.secrets/wallet-mainnet.json). `.secrets` folder has been added to `.gitignore` so your key is kept securely.

You can view deploy script code [here](deploy/scripts/deploy.js).

### Using SDK
Using RedStone SmartWeave SDKs' methods is similar to how you should use them in case of regular JS contracts. You can run a script which compiles contract, deploys it and reads its state by running:

```bash
yarn run read:[network]
```

If you would like to view `read-contract-state.js` script code you can check it out [here](deploy/scripts/read-contract-state.js).
